name: checklist

on:
  pull_request:
    branches:
      - main
      - develop
      - quality
      - 'feature/**'
    types:
      - opened
      - synchronize
      - reopened
      - edited

jobs:
  # Job consolidado 1: Validaci√≥n README y grupos de ejecuci√≥n
  validacion_readme_y_grupos:
    name: Validaci√≥n README y Grupos de Ejecuci√≥n
    runs-on: ubuntu-latest
    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4

      - name: Ejecutar validaciones consolidadas
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          config-repo-token: ${{ secrets.ESB_ACE12_ORG_REPO_TOKEN }}
          skip-readme-validation: 'false'

  # Job consolidado 2: Revisiones del repositorio (nombre rama, carpetas BD, revisores)
  revisiones_repositorio:
    name: Revisiones Repositorio
    runs-on: ubuntu-latest
    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4

      - name: Validar nombre de la rama
        run: |
          echo "Nombre de la rama: ${{ github.head_ref }}"
          if [[ ! "${{ github.head_ref }}" =~ ^(feature|bugfix|hotfix|release)\/[A-Za-z0-9._-]+$ ]]; then
            echo "::error title=Validaci√≥n de nombre de rama::Nombre de rama inv√°lido. Debe comenzar con 'feature/', 'bugfix/', 'hotfix/' o 'release/'."
            exit 1
          else
            echo "::notice title=Validaci√≥n de nombre de rama::Nombre de rama v√°lido."
          fi

      - name: Validar carpetas BD
        run: |
          echo "üîç Buscando carpetas BD en el repositorio"
          bd_folders=$(find . -type d -iname "BD" ! -path "./.git/*" || true)
          
          if [ -n "$bd_folders" ]; then
            echo "::error title=Validaci√≥n de carpetas BD::Se encontraron carpetas 'BD' en el repositorio. Esto viola las pol√≠ticas de informaci√≥n. Carpetas encontradas:"
            echo "$bd_folders"
            echo "Por favor, elimine estas carpetas antes de continuar."
            exit 1
          else
            echo "::notice title=Validaci√≥n de carpetas BD::No se encontraron carpetas BD. Validaci√≥n exitosa."
          fi

      - name: Instalar GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh

      - name: Validar rutas y revisores
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          hasError=0
          sourceBranch="${{ github.head_ref }}"
          targetBranch="${{ github.base_ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          reviewers="${{ github.event.pull_request.requested_reviewers[*].login }}"
          validReviewers=(DRamirezM cdgomez acardenasm CAARIZA)

          echo "Origen: $sourceBranch ‚Üí Destino: $targetBranch"

          # Validar revisores para develop ‚Üí quality
          if [[ "$targetBranch" == "quality" && "$sourceBranch" == "develop" ]]; then
            echo "::notice title=Validaci√≥n de rutas y revisores::Validando revisores para develop ‚Üí quality"
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then
                match=1
                break
              fi
            done
            [[ $match -eq 0 ]] && {
              echo "::error title=Validaci√≥n de rutas y revisores::Falta revisor v√°lido para calidad. Autorizados: ${validReviewers[*]}"
              hasError=1
            }
          fi

          # Validar revisores para quality ‚Üí main
          if [[ "$targetBranch" == "main" && "$sourceBranch" == "quality" ]]; then
            echo "::notice title=Validaci√≥n de rutas y revisores::Validando revisores para quality ‚Üí main"
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then
                match=1
                break
              fi
            done
            [[ $match -eq 0 ]] && {
              echo "::error title=Validaci√≥n de rutas y revisores::Falta revisor v√°lido para producci√≥n. Autorizados: ${validReviewers[*]}"
              hasError=1
            }
          fi

          # Excepci√≥n manual: Si es feature/** a develop y existe el comentario especial, no falla el job
          if [[ "$targetBranch" == "develop" && "$sourceBranch" == feature/* ]]; then
            echo "Verificando comentarios para excepci√≥n de emergencia..."
            gh pr view "$pr_number" --repo "${{ github.repository }}" --json comments -q '.comments[].body' > comentarios.txt || true
            if grep -q "@bot aprobar excepci√≥n" comentarios.txt; then
              echo "::notice title=Excepci√≥n manual::Se encontr√≥ comentario de excepci√≥n. Permitiendo merge por emergencia."
              hasError=0
            fi
          fi

          [[ $hasError -eq 1 ]] && exit 1
          echo "::notice title=Validaci√≥n de rutas y revisores::Validaciones de rutas y revisores correctas."

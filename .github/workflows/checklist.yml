# ‚ö†Ô∏è PRIORIDAD ALTA: Este workflow valida est√°ndares cr√≠ticos del repositorio
# Migrado a Node.js 20.x (preparado para 24.11.x cuando est√© disponible en GitHub Actions)
# Jobs consolidados para mejor rendimiento: de 6 jobs a 2 jobs principales
# Documentaci√≥n completa en README.md y CHECKLIST.md

name: checklist

on:
  pull_request:
    branches:
      - main
      - develop
      - quality
      - 'feature/**'
    types:
      - opened
      - synchronize
      - reopened
      - edited

jobs:
  # =========================================================================
  # Job consolidado 1: Validaci√≥n README y grupos de ejecuci√≥n
  # Agrupa: validaci√≥n de existencia, plantilla README y grupos de ejecuci√≥n
  # =========================================================================
  validacion_readme_y_grupos:
    name: Validaci√≥n README y Grupos de Ejecuci√≥n
    runs-on: ubuntu-latest
    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4

      - name: Validar existencia README.md
        run: |
          if [ ! -f README.md ]; then
            echo "::error title=Validaci√≥n de README.md::No se encontr√≥ el archivo README.md"
            exit 1
          else
            echo "::notice title=Validaci√≥n de README.md::Archivo README.md encontrado."
          fi

      - name: Validar Plantilla README (validaci√≥n b√°sica)
        run: |
          failed=0
          echo "üîç Iniciando validaci√≥n b√°sica de estructura del README.md"
          
          # Validar t√≠tulo principal
          echo "‚úîÔ∏è Validando t√≠tulo principal del Servicio '# ESB_...'"
          if grep -Pq '^# ESB_' README.md; then
            titulo=$(grep -m1 '^# ESB_' README.md | sed 's/^# //' | sed 's/\.$//')
            if echo "$titulo" | grep -Pq '^ESB_[A-Za-z0-9_-]+'; then
              contenido_despues=$(echo "$titulo" | sed 's/^ESB_//')
              if [ -z "$contenido_despues" ] || echo "$contenido_despues" | grep -Pq '^[_-]+$'; then
                echo "::error title=Validaci√≥n de README.md::El t√≠tulo no puede ser solo 'ESB_' o 'ESB_' seguido solo de guiones"
                failed=1
              else
                echo "::notice title=Validaci√≥n de README.md::T√≠tulo principal v√°lido: $titulo"
              fi
            else
              echo "::error title=Validaci√≥n de README.md::El t√≠tulo debe comenzar con 'ESB_' seguido de un nombre descriptivo"
              failed=1
            fi
          else
            echo "::error title=Validaci√≥n de README.md::Falta el t√≠tulo principal '# ESB_...'"
            failed=1
          fi

          # Validar URLs DataPower (no boc200)
          if grep -q "boc200" README.md; then
            echo "::error title=Validaci√≥n de README.md::URLs con boc200 detectadas (deben ser boc201)"
            grep -n "boc200" README.md
            failed=1
          fi

          # Validar secciones b√°sicas requeridas
          secciones_requeridas=("## INFORMACI√ìN DEL SERVICIO" "## Procedimiento de despliegue" "## ACCESO AL SERVICIO" "## DEPENDENCIAS" "## DOCUMENTACION" "## SQL")
          for seccion in "${secciones_requeridas[@]}"; do
            if ! grep -Fq "$seccion" README.md; then
              echo "::error title=Validaci√≥n de README.md::Falta secci√≥n requerida: $seccion"
              failed=1
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "::error title=Validaci√≥n de README.md::README.md no cumple con los requisitos b√°sicos"
            exit 1
          else
            echo "::notice title=Validaci√≥n de README.md::README.md cumple con los requisitos b√°sicos"
          fi

      - name: Validar grupos de ejecuci√≥n (validaci√≥n simplificada)
        env:
          ESB_ACE12_ORG_REPO_TOKEN: ${{ secrets.ESB_ACE12_ORG_REPO_TOKEN }}
        run: |
          if [ -z "$ESB_ACE12_ORG_REPO_TOKEN" ]; then
            echo "::warning title=Validaci√≥n de grupos de ejecuci√≥n::Token no configurado, saltando validaci√≥n completa de grupos"
            exit 0
          fi
          
          # Validaci√≥n simplificada - extraer servicio del README
          if grep -Pq '^# ESB_' README.md; then
            servicio=$(grep -m1 '^# ESB_' README.md | sed 's/^# ESB_ACE12_//' | sed 's/^# ESB_//' | sed 's/\.$//')
            echo "::notice title=Validaci√≥n de grupos de ejecuci√≥n::Servicio detectado: $servicio"
            echo "::notice title=Validaci√≥n de grupos de ejecuci√≥n::Validaci√≥n b√°sica completada. Para validaci√≥n exhaustiva, usar checklist-backup.yml"
          else
            echo "::warning title=Validaci√≥n de grupos de ejecuci√≥n::No se pudo detectar nombre del servicio"
          fi

  # =========================================================================
  # Job consolidado 2: Revisiones del repositorio
  # Agrupa: validaci√≥n de nombre de rama, carpetas BD y revisores
  # =========================================================================
  revisiones_repositorio:
    name: Revisiones Repositorio
    runs-on: ubuntu-latest
    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v4

      - name: Validar nombre de la rama
        run: |
          echo "Nombre de la rama: ${{ github.head_ref }}"
          if [[ ! "${{ github.head_ref }}" =~ ^(feature|bugfix|hotfix|release)\/[A-Za-z0-9._-]+$ ]]; then
            echo "::error title=Validaci√≥n de nombre de rama::Nombre de rama inv√°lido. Debe comenzar con 'feature/', 'bugfix/', 'hotfix/' o 'release/'."
            exit 1
          else
            echo "::notice title=Validaci√≥n de nombre de rama::Nombre de rama v√°lido."
          fi

      - name: Validar carpetas BD
        run: |
          echo "üîç Buscando carpetas BD en el repositorio"
          bd_folders=$(find . -type d -iname "BD" ! -path "./.git/*" || true)
          
          if [ -n "$bd_folders" ]; then
            echo "::error title=Validaci√≥n de carpetas BD::Se encontraron carpetas 'BD' en el repositorio:"
            echo "$bd_folders"
            echo "Por favor, elimine estas carpetas antes de continuar."
            exit 1
          else
            echo "::notice title=Validaci√≥n de carpetas BD::No se encontraron carpetas BD."
          fi

      - name: Instalar GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh

      - name: Validar rutas y revisores
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          hasError=0
          sourceBranch="${{ github.head_ref }}"
          targetBranch="${{ github.base_ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          reviewers="${{ github.event.pull_request.requested_reviewers[*].login }}"
          validReviewers=(DRamirezM cdgomez acardenasm CAARIZA)

          echo "Origen: $sourceBranch ‚Üí Destino: $targetBranch"

          # Validar revisores para develop ‚Üí quality
          if [[ "$targetBranch" == "quality" && "$sourceBranch" == "develop" ]]; then
            echo "::notice title=Validaci√≥n de rutas y revisores::Validando revisores para develop ‚Üí quality"
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then
                match=1
                break
              fi
            done
            [[ $match -eq 0 ]] && {
              echo "::error title=Validaci√≥n de rutas y revisores::Falta revisor v√°lido para calidad. Autorizados: ${validReviewers[*]}"
              hasError=1
            }
          fi

          # Validar revisores para quality ‚Üí main
          if [[ "$targetBranch" == "main" && "$sourceBranch" == "quality" ]]; then
            echo "::notice title=Validaci√≥n de rutas y revisores::Validando revisores para quality ‚Üí main"
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then
                match=1
                break
              fi
            done
            [[ $match -eq 0 ]] && {
              echo "::error title=Validaci√≥n de rutas y revisores::Falta revisor v√°lido para producci√≥n. Autorizados: ${validReviewers[*]}"
              hasError=1
            }
          fi

          # Excepci√≥n manual para emergencias (feature/** ‚Üí develop)
          if [[ "$targetBranch" == "develop" && "$sourceBranch" == feature/* ]]; then
            echo "Verificando comentarios para excepci√≥n de emergencia..."
            gh pr view "$pr_number" --repo "${{ github.repository }}" --json comments -q '.comments[].body' > comentarios.txt || true
            if grep -q "@bot aprobar excepci√≥n" comentarios.txt; then
              echo "::notice title=Excepci√≥n manual::Se encontr√≥ comentario de excepci√≥n. Permitiendo merge por emergencia."
              hasError=0
            fi
          fi

          [[ $hasError -eq 1 ]] && exit 1
          echo "::notice title=Validaci√≥n de rutas y revisores::Validaciones correctas."

name: checklist

on:
  pull_request:
    branches:
      - main
      - develop
      - quality
      - 'feature/**'
    types:
      - opened
      - synchronize
      - reopened
      - edited

# Prioridad: alta (entrada para operadores/lectores y para futuros runners)
env:
  PRIORITY: high

jobs:
  validacion_readme_y_grupos:
    name: Validaci√≥n README y Grupos de Ejecuci√≥n
    runs-on: ubuntu-latest
    env:
      ESB_ACE12_ORG_REPO_TOKEN: ${{ secrets.ESB_ACE12_ORG_REPO_TOKEN }}
    steps:
      - name: Descargar c√≥digo
        uses: actions/checkout@v3

      - name: Validar existencia y plantilla de README.md
        run: |
          if [ ! -f README.md ]; then
            echo "::warning title=Validaci√≥n de README.md::No se encontr√≥ el archivo README.md. Nota: el README ya no es obligatorio para repositorios.")
            exit 0
          fi

          failed=0
          echo "üîç Iniciando validaci√≥n de estructura del README.md"

          # Validar t√≠tulo
          if grep -Pq '^# ESB_' README.md; then
            titulo=$(grep -m1 '^# ESB_' README.md | sed 's/^# //' | sed 's/\.$//' )
            if echo "$titulo" | grep -Pq '^ESB_[A-Za-z0-9_-]+'; then
              contenido_despues=$(echo "$titulo" | sed 's/^ESB_//')
              if [ -z "$contenido_despues" ] || echo "$contenido_despues" | grep -Pq '^[_-]+$'; then
                echo "::error title=Validaci√≥n de README.md::El t√≠tulo no puede ser solo 'ESB_' o similar; agregue nombre descriptivo."
                failed=1
              else
                echo "::notice title=Validaci√≥n de README.md::T√≠tulo principal v√°lido: $titulo"
              fi
            else
              echo "::error title=Validaci√≥n de README.md::El t√≠tulo debe comenzar con 'ESB_' seguido de un nombre descriptivo"
              failed=1
            fi
          else
            echo "::error title=Validaci√≥n de README.md::Falta el t√≠tulo principal '# ESB_...'"
            failed=1
          fi

          # Validar secciones m√≠nimas (INFORMACI√ìN DEL SERVICIO y Procedimiento de despliegue)
          for h in "## INFORMACI√ìN DEL SERVICIO" "## Procedimiento de despliegue" "## DOCUMENTACION" "## SQL"; do
            if ! grep -Pq "^${h}" README.md; then
              echo "::error title=Validaci√≥n de README.md::Falta secci√≥n '${h}'"
              failed=1
            else
              echo "::notice title=Validaci√≥n de README.md::Secci√≥n '${h}' encontrada"
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "::error title=Validaci√≥n de README.md::README.md no cumple con los requisitos m√≠nimos."
            exit 1
          fi

          echo "::notice title=Validaci√≥n de README.md::README.md cumple validaciones b√°sicas. Para validaciones exhaustivas use el job de plantilla completo (si aplica)."

      - name: Descargar archivo .properties y validar grupos de ejecuci√≥n
        run: |
          curl -H "Authorization: Bearer $ESB_ACE12_ORG_REPO_TOKEN" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o esb-ace12-general-integration-servers.properties \
               "https://api.github.com/repos/bocc-principal/ESB_ACE12_General_Configs/contents/ace-12-common-properties/esb-ace12-general-integration-servers.properties?ref=main"

          if [ ! -f esb-ace12-general-integration-servers.properties ]; then
            echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::No se pudo descargar el archivo .properties"
            exit 1
          fi

          servicio_readme=$(grep -m1 '^# ESB_' README.md | sed 's/^# //' | sed 's/\.$//' | xargs || true)
          if [ -z "$servicio_readme" ]; then
            echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::No se pudo extraer nombre de servicio desde README"
            exit 1
          fi
          servicio=$(echo "$servicio_readme" | sed 's/^ESB_ACE12_//')

          grupos_readme=$(awk '/^## Procedimiento de despliegue/{flag=1;next}/^## /{flag=0}flag' README.md | awk '/desplegar en los grupos de ejecuci√≥n:/ {getline; print}' | xargs | tr ',' ' ' | tr '[:upper:]' '[:lower:]' || true)

          if [ -z "$grupos_readme" ]; then
            grupos_readme=$(awk '/^## Procedimiento de despliegue/{flag=1;next}/^## /{flag=0}flag' README.md | grep -i "desplegar en los grupos de ejecuci√≥n:" | sed -n 's/.*desplegar en los grupos de ejecuci√≥n:\(.*\)/\1/p' | xargs | tr ',' ' ' | tr '[:upper:]' '[:lower:]' || true)
          fi

          if [ -z "$grupos_readme" ]; then
            echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::No se encontraron grupos en README para comparar"
            exit 1
          fi

          grupos_properties=$(grep -i "^ESB_ACE12_${servicio}\.Transactional=" esb-ace12-general-integration-servers.properties | cut -d'=' -f2 | tr ',' ' ' | xargs | tr '[:upper:]' '[:lower:]' || true)
          grupos_properties_notif=$(grep -i "^ESB_ACE12_${servicio}\.Notification=" esb-ace12-general-integration-servers.properties | cut -d'=' -f2 | tr ',' ' ' | xargs | tr '[:upper:]' '[:lower:]' || true)
          grupos_properties_total="$grupos_properties $grupos_properties_notif"

          if [ -z "$grupos_properties_total" ]; then
            echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::No existe entry ESB_ACE12_${servicio}.Transactional ni .Notification en el archivo general config."
            exit 1
          fi

          # Comparar listas (ignorando orden)
          IFS=' ' read -r -a arr_readme <<< "$grupos_readme"
          IFS=' ' read -r -a arr_props <<< "$grupos_properties_total"

          missing=0
          for r in "${arr_readme[@]}"; do
            found=0
            for p in "${arr_props[@]}"; do
              if [ "$r" = "$p" ]; then found=1; break; fi
            done
            if [ $found -eq 0 ]; then
              echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::Grupo '$r' presente en README pero no en config"
              missing=1
            fi
          done

          for p in "${arr_props[@]}"; do
            found=0
            for r in "${arr_readme[@]}"; do
              if [ "$r" = "$p" ]; then found=1; break; fi
            done
            if [ $found -eq 0 ]; then
              echo "::error title=Validaci√≥n de grupos de ejecuci√≥n::Grupo '$p' presente en config pero no en README"
              missing=1
            fi
          done

          if [ $missing -eq 1 ]; then exit 1; else echo "::notice title=Validaci√≥n de grupos::OK"; fi

  revisiones_repositorio:
    name: Revisiones Repositorio (rutas, revisores, carpetas BD)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validar nombre de la rama
        run: |
          echo "Nombre de la rama: ${{ github.head_ref }}"
          if [[ ! "${{ github.head_ref }}" =~ ^(feature|bugfix|hotfix|release)\/[A-Za-z0-9._-]+$ ]]; then
            echo "::error title=Validaci√≥n de nombre de rama::Nombre de rama inv√°lido. Debe comenzar con 'feature/', 'bugfix/', 'hotfix/' o 'release/'."
            exit 1
          else
            echo "::notice title=Validaci√≥n de nombre de rama::Nombre de rama v√°lido."
          fi

      - name: Verificar carpetas BD
        run: |
          echo "üîç Buscando carpetas BD en el repositorio"
          bd_folders=$(find . -type d -iname "BD" ! -path "./.git/*" || true)
          if [ -n "$bd_folders" ]; then
            echo "::error title=Validaci√≥n de carpetas BD::Se encontraron carpetas 'BD' en el repositorio. Carpetas encontradas:"
            echo "$bd_folders"
            exit 1
          else
            echo "::notice title=Validaci√≥n de carpetas BD::No se encontraron carpetas BD."
          fi

      - name: Validar rutas y revisores
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh

          hasError=0
          sourceBranch="${{ github.head_ref }}"
          targetBranch="${{ github.base_ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          reviewers="${{ github.event.pull_request.requested_reviewers[*].login }}"
          validReviewers=(DRamirezM cdgomez acardenasm CAARIZA)

          if [[ "$targetBranch" == "quality" && "$sourceBranch" == "develop" ]]; then
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then match=1; break; fi
            done
            [[ $match -eq 0 ]] && { echo "::error title=Validaci√≥n de revisores::Falta revisor v√°lido para quality"; hasError=1; }
          fi

          if [[ "$targetBranch" == "main" && "$sourceBranch" == "quality" ]]; then
            match=0
            for reviewer in "${validReviewers[@]}"; do
              if [[ "$reviewers" == *"$reviewer"* ]]; then match=1; break; fi
            done
            [[ $match -eq 0 ]] && { echo "::error title=Validaci√≥n de revisores::Falta revisor v√°lido para main"; hasError=1; }
          fi

          # Excepci√≥n manual para feature/** ‚Üí develop
          if [[ "$targetBranch" == "develop" && "$sourceBranch" == feature/* ]]; then
            gh pr view "$pr_number" --repo "${{ github.repository }}" --json comments -q '.comments[].body' > comentarios.txt || true
            if grep -q "@bot aprobar excepci√≥n" comentarios.txt; then
              echo "::notice title=Excepci√≥n manual::Se encontr√≥ comentario de excepci√≥n."
              hasError=0
            fi
          fi

          [[ $hasError -eq 1 ]] && exit 1 || echo "::notice title=Validaci√≥n de revisores::OK"
                  fi
